---
- name: Deploy application with Docker Swarm
  hosts: all
  become: yes
  vars_files:
    secrets.yml

  tasks:
    - name: Create project directory on host
      ansible.builtin.file:
        path: /opt/fear
        state: directory
        mode: '0755'

    - name: Copy project files to host
      ansible.builtin.synchronize:
        src: ./
        dest: /opt/fear  
        delete: yes
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=ansible" 

    - name: Initialize Docker Swarm (if not already)
      ansible.builtin.command: docker swarm init --advertise-addr {{ ansible_default_ipv4.address }}
      register: swarm_init
      failed_when: swarm_init.rc != 0 and 'already part of a swarm' not in swarm_init.stderr
      changed_when: swarm_init.rc == 0

    - name: Build Docker image locally
      community.docker.docker_compose:
        project_src: /opt/fear
        build: yes
      register: build_result

    - name: Deploy the stack
      community.docker.docker_stack:
        name: my-app
        state: present
        compose:
          - /opt/fear/docker-compose.yml
      environment:
        BOT_TOKEN: "{{ bot_token }}"
        MONGO_URL: "{{ mongo_url }}"

    - name: Prune old images (for cleanup, optional)
      community.docker.docker_prune:
        images: yes
        images_filters:
          dangling: yes
